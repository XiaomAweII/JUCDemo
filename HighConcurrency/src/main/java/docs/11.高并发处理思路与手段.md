# 高并发处理思路与手段

重点是根据一些实际的高并发场景来实践处理的一些思路和手段。

## 1. 扩容

如何理解以及什么时候会想到扩容呢？

之前的占用内存大小取决于工作内存里变量的多少与大小。单个线程占用内存通常不会很大，但是随着并发线程不断增加，从几十到几百几千，甚至上万。这就需要扩容了，最简单的，比如考虑给系统升级一下内存，让内存更大一些，这样的话，应用能够分配更多的内存来支撑实际的项目。复杂一点，可以会考虑到再增加一台 服务器来分担一下压力。

- 垂直扩容（纵向扩展）：提高系统部件能力
- 水平扩容（横向扩展）：增加更多系统成员来实现

这两种方案，就是扩容的两种手段。增加内存的方法属于垂直扩容，也称为垂直扩展或者纵向扩展。增加服务器的方法属于水平扩容，也成为水平扩展或横向扩展。

### 垂直扩展

在垂直扩展模型当中，我们想要增加系统负荷，就意味着要在系统现有的部件上下功夫，就是通过提高系统部件的每辆车一次可以运25根木材，计算花费一个小时的情况下，可以运送到指定地点等待处理木材的数量。通过这些数字呢，我们就可以算出系统最大负荷是三辆卡车，乘以25根木材，再乘以1小时等于75根木材每小时。现在如果我们需要每小时可以处理150根木材，同时我们选择垂直扩展模型，我们应该怎么办呢？

我们至少做到以下两件事，卡车运输量由每小时25根木材变成每小时50根，要么使每辆卡车的运输时间减半，即要每辆卡车需要运输一小时调整为30分钟。这样三辆卡车乘以50根木材，乘以1小时就等于150根木材或者是三辆卡车乘以25根木材乘以30分钟也等于150根木材每小时。没用增加系统的成员数，但是通过增加系统成员的生产效率来获得期望的负荷量。

### 水平扩展

水平扩展模型当中，不是通过增加单个系统成员的负荷，而是简单的通过增加更多的系统成员来实现，也就是说增加到每小时150根木材的时候，只需要额外增加三辆卡车就可以了。这个例子当中，系统里面的每个成员的生产力依然保持不变，通过更多的卡车来提供系统的能力。这种方式，就很容易想到服务器集群。

需要注意的是，我们需要记住每种扩展策略下意想不到的开销，当我们去提升系统负荷时，这些单独的组件需要在管理上花费更多。接着用运送木材的例子来说，如果需要或者更高的车厢，也许有的路因为桥的高度对车辆高度有要求，或者基于巷子的宽度，车宽不能太大，又或者由于机动车安全驾驶要求，车厢不能太长。这里的限制，就是对单个卡车做垂直扩展，能做到什么程度。我们更多的处理器要求更多的空间，进而要求更多的服务器架。相反的采用水平扩展的系统，将额外的开销放在系统中连接起来的共享的组件上，当我们去提升系统负荷时，共享的开销和新增加的成员之间的协调性有关。

在运送木材的例子当中，在路上增加更多卡车时，路就是共享资源，也就成了约束条件，这条路上适合同时跑多少辆卡车是一个很关键的因素，这些木材的运输量，就会受到路的限制，也是我们要面临的问题。如果再来看水平扩展数据，连接时的网络开销，网络其实是各个系统的共享资源，当你为系统增加更多的节点时，共享资源的负荷也会随之增加。

### 数据库

为什么数据库是最边缘的呢？因为数据库通常时共享资源，绝大部分系统只有一个数据库，或者只有一个主库，数据库你必须要考虑的一个重要问题是自己所面临的系统是什么类型的呢？比如说博客，在博客上，人们大部分时间都是在浏览博客，这是个读的操作，只有少数时间都是在浏览博客，这是个读操作，只有少数时间在评论或者发表博文，对应的是写操作。相反的，关于写操作非常多的例子，比如大型网站的订单交易系统，这个系统的主要负载是在处理记录交易，它是写操作，偶尔会查找交易，这时读操作，它的主要工作其实是在记录业务数据。

#### 读操作扩展：memcache、redis、CDN等缓存

如果系统的读操作非常多，那么通过关系型数据分组是一个不错的选择，结合关系型数据库，那么系统将会非常容易扩展。在这种模式中，如果数据库超负荷运行，那么将更多的数据放入缓存中来，缓解系统的读压力，当没有更多的数据时，往很多核的处理器来获取更多的运行通道。

#### 写操作扩展：Cassandra、Hbase等

如果系统写操作非常多，那么很可能希望考虑使用可水平扩展的数据存储方式，比如Cassandra、Hbase等。和大多数关系型数据管理系统不同，随着数据量增长，缓存并不能像在读操作比较频繁的系统中起到那么大的作用，很多写操作频繁的系统一开始使用垂直扩展的方式，但是很快发现并不能根本解决问题，这是为什么？因为硬盘数和处理器数在某一点达到了平衡，在这个边界上再增加一个处理器或者一个硬盘，都不会有太大的帮助。采取水平扩展策略，那么你将达到一个拐点，在这个拐点之后，如果再增加一个节点，都远比使用更多的硬盘来的实惠。

和计算机的大多数东西一样，好的解决方法通常并不像列出来的那么简单。这里只是简化思想，用来说明这其中的概念。处理中，每个步骤都要思考问题，它没有模版或者对应的软件，帮助建立一个完整可靠的可扩展的系统，就像每一个解决方案进行精心、正确的设计和开发。一定要根据自己系统类型及实际的场景分析该做什么样的扩容，选择合适的处理方案。